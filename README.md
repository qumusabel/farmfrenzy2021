#  Инженерная задача по Информационной безопасности НТИ 2021 | Весёлая Ферма

## Задача
 На финальном мероприятии нам дали задание, суть которого была в том, что нам нужно было защитить подвергшийся атаке телецентр, выявить наибольшее количество уязвимых мест, разработать способы устранения атак, а также найти и обезвредить вредонос. 
 
## Вход во внутреннюю сеть

### ?

Сначала было произведено сканирование портов, найдены следующие:
```
| Порт | Прот. | Описание | |——-|——-|——————————————–| | 81 | HTTP | Хостит обфусцированный файл run.py | | 5000 | HTTP | Веб-приложение, сайт провайдера (?) NetGen | | 8037 |      UDP? | Открыт, но не отвечает | | 51515 | TCP | Какой-то сервис, просит пароль |
```
На сервисе NetGen есть страницы /register, /login, /logout Регистрируем пользователя, доступна функция создания тикетов. В параметре POST title обнаружена SSTI (предположительно, Jinja2) Некоторые ключевые слова фильтруются, причем необязательно в составе пейлоада (например, config)

Далее нами было получено SSTI RCE в сервисе на :5000



### server.py:224 status_route() Possible RCE, weak filter

#### Решение:
>Use whitelist instead of blacklist, only allow options to uptime
```
└─$ diff ../app/server.py server.py                                                           
224c224,226
&lt;     bad_words = ['whoami', 'id', 'python', 'php', 'bash'] #hacker shouldn't pass
---
&gt;     # Only allow options to `uptime`: 
&gt;     good_words = ['-p', '--pretty', '-h', '--help', '-s', '--since', '-V', '--version']
&gt; 
227,228c229,230
&lt;         for i in bad_words:
&lt;             if i in req:
---
&gt;         for token in req.split():
&gt;             if token not in good_words:
229a232
```

* Создать пользователя " || "admin : passwd
* Зайти за " || "admin : admin <— слабая политика паролей!
* Go to /dialog?u=? -> dialog leakage
* Change " || "admin‘s passwd, now admin‘s password is changed, too
* Proposed patch: use proper DB access methods w/escaping

In future: enforce password policies

### Взлом run.py на хосте :81

#### Сначала деобфусцируем скрипт:
>
- Упростим имена, переименуем все в более понятный вид
- Упростим hex-строки, получается encode, unhexlify и прочее
- Избавимся от непонятных вызовов locals(), getattr():
  - getattr(binascii, 'unhexlify')(...) 
  - binascii.unhexlify(...)
  - locals['somefunc'](..., ...) 
  - somefunc(..., ...)
- Последний шаг – избавимся от списков чисел. Можно заметить, что они используюстя только как аругмент к somefunc, при этом функция похожа на шифр Виженера. Для того, чтобы получить оригинальные строки, просто вызовем функцию с нужными аргументами. Выясняется, что большой список в начале файла – это зашифрованный приватный ключ RSA.

#### Алгоритм:

* Загрузить ключ RSA
* Получить hex-строку от пользователя
* Расшифровать строку
* Проверить соответствие с заданной строкой, если совпадают – вывести ~~флаг~~ важную информацию

#### Взлом:

>Приватный ключ дан почти в открытом виде, зашифруем с помощью него требуемую строку, затем подключимся к серверу на порту :51515, нас попросят ввести hex, отправим шифротекст, в ответ прилетит зашифрованная информация. С помощью скрипта и коюча ее расшифруем, получим сообщение с данными для входа во внутреннюю сеть

![kts](https://user-images.githubusercontent.com/67109334/110935184-23668900-8340-11eb-9bba-bb4c503712b1.png)

### SQLi №1

В ходе тестирования на проникновение, «Веселая ферма» смоделировала возможные действия злоумышленника на сайте телецентра “Sirius Game” и выявила возможность проведения атаки типа SQLi. Данная уязвимость даёт злоумышленнику возможность получения конфиденциальной информации пользователей, а именно переписок в личных диалогах.

Далее представлена некоторая техническая информация.

Для эксплуатации описанной выше уязвимости, необходимо послать GET запрос на страницу ```/dialog.``` В качестве уязвимого параметра используется ```‘u’```, в функционале сервиса он необходим для указания собеседника, переписку с которым необходимо загрузить.

Полезной нагрузкой в данном векторе атаки может быть ```" or "1" = "1" --```, однако не отрицаются другие варианты эксплуатирования данной уязвимости. Уязвимость расположена в функции ```get_dialog()``` и устраняется безопасной передачей аргументов в SQL-запрос:
```
└─$ diff server.py patched_sqli.py                                    
257c257
&lt;     c.execute('SELECT * FROM messages where to_user="' + username + '" and from_user="' + companion + '" or to_user="' + companion + '" and from_user="' + username + '"')                                                                    
---
&gt;     c.execute('SELECT * FROM messages where to_user=(?) and from_user=(?) or to_user=(?) and from_user=(?)', (username, companion, companion, username))
```

### :80 server
---------------

### SQLi №2
В ходе тестирования на проникновение «Веселая ферма» смоделировала возможные действия злоумышленника на сайте телецентра “Sirius Game” и выявила возможность проведения атаки типа SQLi. Данная уязвимость даёт злоумышленнику возможность смены пароля любого пользователя, в том числе администратора.

Далее представлена некоторая техническая информация.

Для эксплуатации описанной выше уязвимости, необходимо зарегистрировать аккаунт с логином ```[username]"--```, где username это логин атакуемого пользователя, например ```admin"--```. Следующим шагом, необходимо сменить пароль созданного пользователя воспользовавшись функционалом ```/change_passwd```. После выполнения этих шагов, злоумышленник получает доступ к аккаунту атакуемого пользователя и может войти в систему с данными ```[username]:[new password]```

Уязвимость расположена в функции ```change_user_passwd()``` и устраняется безопасной передачей аргументов в SQL-запрос:
```
└─$ diff server.py patched_sqli.py 
257c257
&lt;         c.execute('UPDATE staff set password=(?) where username="' + session[0] + '"', (password, ))                                                          
---
&gt;         c.execute('UPDATE staff set password=(?) where username=(?)', (password, session[0])) 
```

## Патчи
